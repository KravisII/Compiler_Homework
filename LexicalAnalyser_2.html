<!DOCTYPE html>
<html lang="en" class="no-backdropfilter no-touch">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>编译原理 实验1 词法分析</title>
    <link rel="stylesheet" href="global-header.css">
</head>
<body>
<nav class="global-nav">
    <div class="gn-wrapper">
        <div class="gn-icons">
            <span class="gn-icons-item gn-kravis"><a href="#" class="gn-kravis-content"></a></span>
            <span class="gn-icons-item gn-menu-icon js gn-button">
                <span class="gn-menu-icon--top"><span class="gn-menu-icon--top-content"></span></span>
                <span class="gn-menu-icon--middle"><span class="gn-menu-icon--middle-content"></span></span>
                <span class="gn-menu-icon--bottom"><span class="gn-menu-icon--bottom-content"></span></span>
            </span>
        </div>
        <div class="gn-menu js">
            <ul class="gn-menu-items">
                <li class="gn-menu-item about">
                    <a class="gn-menu-link" href="#">About</a>
                </li>
                <li class="gn-menu-item demos has-sub">
                    <a class="gn-menu-link" href="#">Demos</a>
                    <ul class="gn-menu-sub-items">
                        <li class="gn-menu-sub-item"><a class="gn-menu-sub-link" href="#">Music Player</a></li>
                        <li class="gn-menu-sub-item"><a class="gn-menu-sub-link" href="#">Lyric Controller</a></li>
                        <li class="gn-menu-sub-item"><a class="gn-menu-sub-link" href="#">Music Controller</a></li>
                        <li class="gn-menu-sub-item"><a class="gn-menu-sub-link" href="#">Lexical Analyser</a></li>
                    </ul>
                </li>
                <li class="gn-menu-item types has-sub">
                    <a class="gn-menu-link" href="#">Types</a>
                    <ul class="gn-menu-sub-items">
                        <li class="gn-menu-sub-item"><a class="gn-menu-sub-link" href="#">Articles</a></li>
                        <li class="gn-menu-sub-item"><a class="gn-menu-sub-link" href="#">Photos</a></li>
                        <li class="gn-menu-sub-item"><a class="gn-menu-sub-link" href="#">Others</a></li>
                    </ul>
                </li>
                <li class="gn-menu-item search"><a class="gn-menu-link" href="#">Search</a></li>
                <input class="gn-searchform-input js" type="text" placeholder="Search">
            </ul>
        </div>

    </div>
</nav>

<div id="gn-viewport-emitter"></div>
<div class="gn-curtain"></div>

<style>
    .no-select {
        -webkit-user-select:none;
    }

    .wrapper {
        width: 100%;
        min-width: 320px;
        box-sizing: border-box;
    }

    .wrapper-inner {
        width: 100%;
        max-width: 1020px;
        margin: 0 auto;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
    }

    .input-area {
        background: #D8D8D8;
        width: 50%;
        min-width: 280px !important;
    }

    #input-textarea {
        resize: none;
        outline: 0 none;
        border: 0 none;
        width: 100%;
        font-size: 16px;
        font-family: Menlo;
        background: transparent;
        box-sizing: border-box;
        padding: 25px 20px;
        flex-grow: 1;
    }

    .middle-line {
        width: 4px;
        background: #000;
        cursor: col-resize;
    }

    .output-area {
        background: #D8D8D8;
        width: 50%;
        min-width: 300px !important;
    }

    .input-area-title,
    .output-area-title {
        background-color: #F8F8F8;
    }

    .input-area-title > h1,
    .output-area-title > h1 {
        margin: 0;
        font-size: 22px;
        font-weight: 500;
        line-height: 2em;
        padding: 0 22px;
    }

    .input-area-container {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .input-area-container,
    .output-area-container {
        height: calc(100vh - 100px);
        box-sizing: border-box;
    }

    .output-area-container {
        overflow-y: scroll;
        padding-top: 1em;
    }

    .input-area-buttons {
        width: 100%;
        display: flex;
        justify-content: space-around;
        margin-bottom: 1em;
    }

    .small .input-area-buttons {
        flex-direction: column;
    }

    .input-area-buttons > button {
        width: 48%;
        max-width: 240px;
        border: 0 none;
        color: #FFF;
        font-size: 16px;
        padding: 12px 0 13px 0;
        margin: 0;
        cursor: pointer;
        transition: background 0.25s;
        outline: 0 none;
    }

    .small .input-area-buttons > button {
        max-width: 1080px;
        width: 100%;
        height: 3em;
    }

    .small .input-area-buttons > button + button {
        margin-top: 0.5em;
    }

    .input-area-buttons > button.cancel {
        background: #e74c3c;
    }

    .input-area-buttons > button.cancel:hover,
    .input-area-buttons > button.cancel:focus {
        background: #ec7063;
    }

    .input-area-buttons > button.cancel:active {
        background: #dc2d1b;
    }

    .input-area-buttons > button.submit {
        background: #3498db;
    }

    .input-area-buttons > button.submit:hover,
    .input-area-buttons > button.submit:focus {
        background: #5dade2;
    }

    .input-area-buttons > button.submit:active {
        background: #2383c4;
    }

    .output-area-container {
    }

    .output-area-container > section > header {
        background: #AEAEAE;
        padding: 0 24px;
    }

    .output-area-container h2 {
        font-size: 18px;
        font-weight: 500;
        line-height: 2em;
        margin: 0;
    }

    .output-area-container h2::after {
        content: " >";
    }

    .section-container {
        font-family: Menlo;
        padding: 0 22px;
        margin: 1em 0;
    }

    .token-list {
        width: 100%;
        border-collapse: collapse;
        empty-cells: show;
        text-align: left;
    }

    .token-list > thead > tr {
        border-bottom: 3px solid #000;
    }

    .token-list > thead > tr > th {
        padding: 0 0 8px;
        font-family: "Myriad Set Pro", -apple-system, -apple-system-font, "Helvetica Neue", "Arial", "PingFang SC", "Hiragino Sans GB", "STHeiti", "Microsoft YaHei", "Microsoft JhengHei", "Source Han Sans SC", "Noto Sans CJK SC", "Source Han Sans CN", "Noto Sans SC", "Source Han Sans TC", "Noto Sans CJK TC", "WenQuanYi Micro Hei", SimSun, sans-serif;
    }

    .token-list tr > th:nth-child(1),
    .token-list tr > th:nth-child(1) {
        width: 30%;
        padding-left: 1em;
    }

    .token-list > tbody > tr > th {
        padding: 6px 0 7px;
        font-weight: 100;
    }

    .token-list > tbody > tr:nth-child(2n) {
        background: #C0C0C0;
    }

    .token-list > tbody > tr:hover {
        /*background: #A3A3A3;*/
    }

    .token-list > tbody > tr.error-token {
    	background: #e74c3c;
    }

    @media screen and (max-width: 768px) {
        .wrapper {
            margin-top: 1em;
        }

        .wrapper-inner {
            flex-direction: column;
        }

        .middle-line {
            display: none;
        }

        .input-area,
        .output-area {
            width: 100% !important;
        }

        .input-area-container {
            height: 100%;
        }

        #input-textarea {
            height: 320px;
        }

        .output-area-container {
            overflow: visible;
            height: auto;
        }
    }

    @media screen and (max-width: 414px) {
        .input-area-buttons {
            flex-direction: column;
        }
        .input-area-buttons > button {
            max-width: 1080px;
            width: 100%;
            height: 3em;
        }

        .input-area-buttons > button + button {
            margin-top: 0.5em;
        }
    }
</style>

<div class="wrapper">
    <div class="wrapper-inner">
        <div class="input-area">
            <header class="input-area-title">
                <h1>Input Area</h1>
            </header>
            <div class="input-area-container">
                <textarea name="input-textarea" id="input-textarea"></textarea>
                <div class="input-area-buttons">
                    <button class="cancel">Cancel</button>
                    <button class="submit">Submit</button>
                </div>
            </div>
        </div>
        <div class="middle-line"></div>
        <div class="output-area">
            <header class="output-area-title">
                <h1>Output Area</h1>
            </header>
            <div class="output-area-container">
                <section class="source-code">
                    <header class="source-code-title">
                        <h2>Source Code</h2>
                    </header>
                    <div class="source-code-container section-container"></div>
                </section>
                <section class="after-preprocess">
                    <header class="after-preprocess-title">
                        <h2>After Preprocess</h2>
                    </header>
                    <div class="after-preprocess-container section-container"></div>
                </section>
                <section class="token-list">
                    <header class="token-list-title">
                        <h2>Token List</h2>
                    </header>
                    <div class="token-list-container section-container">
                        <table class="token-list">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </div>
</div>
</body>
<script src="global-header.js"></script>
<script>
    "use strict";
    var ViewController = {
        create: function () {
            var o = {};

            o.initialize = function () {
                this.setNodeReferences();
                this.setNodeEvents();
            };

            o.setNodeReferences = function () {
                this.middleLine = document.querySelector(".middle-line");
                this.wrapper = document.querySelector(".wrapper");
                this.wrapperInner = document.querySelector(".wrapper-inner");
                this.inputArea = document.querySelector(".input-area");
                this.outputArea = document.querySelector(".output-area");
            };

            o.setNodeEvents = function () {
                this.middleLine.addEventListener("mousedown", this.onMouseDownMiddleLine.bind(this), false);
            };

            o.onMouseDownMiddleLine = function () {
                this.wrapperInner_left = this.wrapperInner.getBoundingClientRect().left;
                this.wrapperInner_width = this.wrapperInner.getBoundingClientRect().width;
                this.wrapper.classList.add("no-select");
                document.addEventListener("mousemove", this.onMouseMoveMiddleLine, false);
                document.addEventListener("mouseup", this.onMouseUpMiddleLine, false);
            };

            o.onMouseMoveMiddleLine = function (event) {
                var _percent = (event.clientX - o.wrapperInner_left) * 100 / o.wrapperInner_width;
                o.inputArea.style.width = _percent + "%";
                o.outputArea.style.width = (100 - _percent) + "%";
                if (parseInt(getComputedStyle(o.inputArea).width) <= 370) {
                    o.inputArea.classList.add("small");
                } else {
                    o.inputArea.classList.remove("small");
                }
            };

            o.onMouseUpMiddleLine = function () {
                o.wrapper.classList.remove("no-select");
                document.removeEventListener("mousemove", o.onMouseMoveMiddleLine, false);
                document.removeEventListener("mouseup", o.onMouseUpMiddleLine, false);
            };

            o.initialize();
            return o;
        }
    };

    var LexicalAnalyser = {
        create: function () {
            var o = {};

            // Others
            o.name = "LexicalAnalyser";

            // Value
            o.TOKENNUM = 0;

            // Functions
            o.main = function () {
                this.setNodeReferences();
                this.testInput();
                this.setEventListeners();
                this.setDataValue();
            };

            o.testInput = function () {
                this.inputTextarea.value = "\/*example*\/\n    b=1\\\n00\n101:a=2*(1+3)\n    IF(b>10) THEN\n        a=1\n    ELSE IF(b>=5) THEN\n        a=2\n    ELSE\n        GOTO 101";
            };

            o.setNodeReferences = function () {
                this.inputTextarea = document.querySelector("#input-textarea");
                this.submitButton = document.querySelector(".input-area-buttons > .submit");

                // NEW
                this.cancelButton = document.querySelector(".input-area-buttons > .cancel");
                this.sourceCodeContainer = document.querySelector(".source-code-container");
                this.afterPreprocessContainer = document.querySelector(".after-preprocess-container");
                this.tokenList = document.querySelector(".token-list");
            };

            o.setEventListeners = function () {
                this.submitButton.addEventListener("click", this.clickSubmit.bind(this));
                this.cancelButton.addEventListener("click", this.clickCancel.bind(this));
            };

            o.clickSubmit = function () {
            	if (this.TOKENNUM === 0) {
            		this.start();
            	} else {
            		// Show Tip
            		alert("Are you sure?");
            	}
            };

            o.clickCancel = function () {
                // Clear All Data
            };

            o.setDataValue = function () {
                this.keyword = ["IF", "THEN", "ELSE", "GOTO"];
                this.operator = ["+", "-", "*", "/"];
                this.comparision = [">", ">=", "<", "<=", "=", "<>"];
                this.interpunction = [",", ":", "(", ")"];
            };

            o.start = function () {
                // Get Source Code
                this.inputStr = this.inputTextarea.value;
                this.sourceCodeContainer = document.querySelector(".source-code-container");
                this.sourceCodeContainer.innerText = this.inputStr;

                // Begin Pre Process
                this.inputStr = this.preProcess(this.inputStr);
                this.afterPreprocessContainer.innerText = this.inputStr;

                // Begin Process
                this.process(this.inputStr);
            };

            o.preProcess = function (_str) {
                var _tempStr = this._removeComment(_str);
                _tempStr = this._removeLineBreak(_tempStr);
                _tempStr = this._removeMultiSpace(_tempStr);
                _tempStr = this._addEOF(_tempStr);
                return _tempStr;
            };

            o._removeComment = function (_str) {
                var _regStr = "(/\\\*([^*]|[\\\r\\\n]|(\\\*+([^*/]|[\\\r\\\n])))*\\\*+/)|(//.*)";
                var _reg = new RegExp(_regStr,"g");
                return _str.replace(_reg, "");
            };

            o._removeLineBreak = function (_str) {
                var _reg = /\\\n/g;
                return _str.replace(_reg, "");
            };

            o._removeMultiSpace = function (_str) {
                var _reg = /\s+/g;
                return _str.replace(_reg, " ");
            };

            o._addEOF = function (_str) {
                return _str + "#";
            };

            o.process = function (_str) {
                var _length = _str.length;
                for (var i = 0; i < _length; 0) {
                    if (_str[i] === ' ') {
                        i++;
                    } else if (_str[i] === '#') {
                        break;
                    } else if (this.isAlpha(_str[i])) {
                        i = this.letterProcess(i)
                    } else if (this.isNum(_str[i])) {
                        i = this.numberProcess(i);
                    } else {
                        i = this.otherProcess(i)
                    }
                }
            };

            o.showToken = function (_value, _type) {
                if (this.TOKENNUM === 0) {
                    this.createTableHead();
                    this.TOKENNUM++;
                }

                var _tbody = this.tokenList.querySelector("tbody");
                _tbody.innerHTML += "<tr><th>" + this.TOKENNUM + "</th><th>" + _type + "</th><th>" + _value + "</th></tr>";
                if (_type === "ERROR") {
                	this.showErrorToken(this.TOKENNUM);
                }
                this.TOKENNUM++;
            };

            o.createTableHead = function () {
                var _thead = this.tokenList.querySelector("thead");
                _thead.innerHTML = "<tr><th>#</th><th>Type</th><th>Value</th></tr>";
            };

            o.showErrorToken = function (_tokenNum) {
            	var _tr = this.tokenList.querySelectorAll("tbody > tr");
            	_tr[_tokenNum-1].classList.add("error-token");
            };

            // To be use
            o.clearTableHead = function () {
                var _thead = this.tokenList.querySelector("thead");
                _thead.innerHTML = "";
            };

            o.letterProcess = function (_i) {
                var _letter = "";
                var _lineNum = "";
                while (this.isAlNum(this.inputStr[_i])) {
                    _letter += this.inputStr[_i];
                    _i++;
                }
                if (this.isLegal(_letter, this.keyword)) {
                    this.showToken(_letter, "keyword");
                    if (_letter === "GOTO") {
                        _i++;
                        while (this.isNum(this.inputStr[_i])) {
                            _lineNum += this.inputStr[_i];
                            _i++;
                        }
                        this.showToken(_lineNum, "linenumber");
                    }
                } else {
                    this.showToken(_letter, "identifier");
                }
                return _i;
            };

            o.numberProcess = function (_i) {
                var _num = "";
                while (this.isNum(this.inputStr[_i])) {
                    _num += this.inputStr[_i];
                    _i++;
                }
                if (this.isAlpha(this.inputStr[_i])) {
                    while (this.isAlNum(this.inputStr[_i])) {
                        _num += this.inputStr[_i];
                        _i++;
                    }
                    this.showToken(_num, "ERROR");
                } else if (this.inputStr[_i] === ":") {
                    this.showToken(_num, "linenumber");
                } else {
                    this.showToken(_num, "const");
                }
                return _i;
            };

            o.otherProcess = function (_i) {
                var _other = "";
                if (this.inputStr[_i] === "(") {
                    _other += this.inputStr[_i];
                    _i++;
                }
                while (!this.isAlNum(this.inputStr[_i]) &&
                (this.inputStr[_i] != " ") &&
                (this.inputStr[_i] != "(") &&
                (this.inputStr[_i] != ")")) {
                    _other += this.inputStr[_i];
                    _i++;
                }
                if (this.inputStr[_i] === ")") {
                    _other += this.inputStr[_i];
                    _i++;
                }

                if (this.isLegal(_other, this.operator) || this.isLegal(_other, this.comparision)) {
                    this.showToken(_other, "operator");
                } else if (this.isLegal(_other, this.interpunction)) {
                    this.showToken(_other, "delimiter");
                } else {
                    this.showToken(_other, "ERROR");
                }
                return _i;
            };

            o.isLegal = function (_char, _type) {
                return !!(_type.includes(_char));
            };

            o.isNum = function (_char) {
                if (_char.length != 1) {
                    return false;
                } else {
                    var _reg = /\d/;
                    return _reg.test(_char);
                }
            };

            o.isAlpha = function (_char) {
                if (_char.length != 1) {
                    return false;
                } else {
                    var _reg = /[a-zA-Z]/;
                    return _reg.test(_char);
                }
            };

            o.isAlNum = function (_char) {
                return !!(this.isNum(_char) || this.isAlpha(_char))
            };

            o.main();
            return o;
        }
    };

    var VC = ViewController.create();
    var LA = LexicalAnalyser.create();
</script>
</html>