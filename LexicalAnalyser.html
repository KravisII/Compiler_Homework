<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta charset="UTF-8">
	<title>编译原理 实验1 词法分析</title>
</head>
<style>
body {
	margin: 0;
}
.wrapper {
	-webkit-user-select:none;
	min-width: 320px;
	max-width: 1080px;
	width: 100%;
	height: 100vh;
	margin: 0 auto;
	background: #222;
	display: flex;
	align-content: space-between;
}

	.input-area,
	.output-area {
		min-width: 320px !important;
	}

	.input-area {
		background: #AAA;
		padding: 1em;
		display: flex;
		flex-direction: column;
		align-content: space-between;
	}

		#input-form {
			display: block;
			width: 100%;
			box-sizing: border-box;
			outline: 0 none;
			/*flex: 1 1 300px;*/
			flex-grow: 1;
			/*max-height: 600px;*/
			resize: none;
		}

		.input-buttons {
			display: flex;
			align-content: space-between;
		}
			.input-buttons > button {
				width: 100%;
			}

		#input-submit {

		}

		#input-form,
		#input-submit {
			
		}

	.control-line {
		border-left: 10px solid red;
		cursor: col-resize;
	}

	.output-area {
		overflow-y: auto;
		background: #CCC;
		padding: 1em;
		flex: auto;
	}

</style>
<body>

<div class="wrapper">
	<div class="input-area">
		<textarea id="input-form" ></textarea>
		<div class="input-buttons">
			<button id="input-submit">Submit</button>
			<button id="input-cancel">Cancel</button>
		</div>
	</div>
	<div class="control-line"></div>
	<div class="output-area">
		<div id="process-content"></div>
		<div id="output-content"></div>		
	</div>
</div>


</body>
<script>
var LexicalAnalyser = {
	create: function () {
		var o = {};

		// Others
		o.name = "LexicalAnalyser";

		// Nodes
		o.outputContent;

		// Key Words
		o.keyword;
		o.operator;
		o.comparision;
		o.interpunction;

		// Strings
		o.inputStr;

		// Functions
		o.main = function () {
			this.setNodeReferences();
			this.testInput();
			this.setEventListeners();
			this.setDataValue();
		};

		o.testInput = function () {
			this.inputForm.value = "\/*example*\/\n    b=1\\\n00\n101:a=2*(1+3)\n    IF(b>10) THEN\n        a=1\n    ELSE IF(b>=5) THEN\n        a=2\n    ELSE\n        GOTO 101";
		};

		o.setNodeReferences = function () {
			this.inputForm = document.querySelector("#input-form");
			this.inputSubmit = document.querySelector("#input-submit");
			this.processContent = document.querySelector("#process-content");
			this.outputContent = document.querySelector("#output-content");
		};

		o.setEventListeners = function () {
			this.inputSubmit.addEventListener("click", this.clickSubmit.bind(this));
		};

		o.clickSubmit = function () {
			this.start();
		};

		o.setDataValue = function () {
			this.keyword = ["IF", "THEN", "ELSE", "GOTO"];
			this.operator = ["+", "-", "*", "/"];
			this.comparision = [">", ">=", "<", "<=", "=", "<>"];
			this.interpunction = [",", ":", "(", ")"];
		};

		o.showMessage = function (_text, _title) {
			this.processContent.innerText += _title + ":\n";
			this.processContent.innerText += _text + "\n\n";
		};

		o.start = function () {
			// Get Source Code
			this.inputStr = this.inputForm.value;
			this.showMessage(this.inputStr, "Source Code");
			// Begin Pre Process
			this.inputStr = this.preProcess(this.inputStr);
			this.showMessage(this.inputStr ,"Pre Process");
			// Begin Process
			this.process(this.inputStr);
		};

		o.preProcess = function (_str) {
			var _tempStr = this._removeComment(_str);
			_tempStr = this._removeLineBreak(_tempStr);
			_tempStr = this._removeMultiSpace(_tempStr);
			_tempStr = this._addEOF(_tempStr);
			return _tempStr;
		};

		o._removeComment = function (_str) {
			var _regStr = "(/\\\*([^*]|[\\\r\\\n]|(\\\*+([^*/]|[\\\r\\\n])))*\\\*+/)|(//.*)"; 
			var _reg = new RegExp(_regStr,"g"); 
			return _str.replace(_reg, "");
		};

		o._removeLineBreak = function (_str) {
			var _reg = /\\\n/g;
			return _str.replace(_reg, "");
		};

		o._removeMultiSpace = function (_str) {
			var _reg = /\s+/g;
			return _str.replace(_reg, " ");
		};

		o._addEOF = function (_str) {
			return _str + "#";
		}

		o.process = function (_str) {
			var _length = _str.length;
			for (var i = 0; i < _length; 0) {
				if (_str[i] === ' ') {
					i++;
					continue;
				} else if (_str[i] === '#') {
					break;
				} else if (this.isAlpha(_str[i])) {
					i = this.letterProcess(i)
				} else if (this.isNum(_str[i])) {
					i = this.numberProcess(i);
				} else {
					i = this.otherProcess(i)
				}
			}
		};

		o.showToken = function (_value, _type) {
			this.outputContent.innerText += '["' + _type + '", "' + _value + '"],\n';
		};

		o.letterProcess = function (_i) {
			var _letter = "";
			var _lineNum = "";
			while (this.isAlNum(this.inputStr[_i])) {
				_letter += this.inputStr[_i];
				_i++;
			}
			if (this.isLegal(_letter, this.keyword)) {
				this.showToken(_letter, "keyword");
				if (_letter === "GOTO") {
					_i++;
					while (this.isNum(this.inputStr[_i])) {
						_lineNum += this.inputStr[_i];
						_i++;
					}
					this.showToken(_lineNum, "linenumber");
				}
			} else {
				this.showToken(_letter, "identifier");
			}
			return _i;
		};

		o.numberProcess = function (_i) {
			var _num = "";
			while (this.isNum(this.inputStr[_i])) {
				_num += this.inputStr[_i];
				_i++;
			}
			if (this.isAlpha(this.inputStr[_i])) {
				while (this.isAlNum(this.inputStr[_i])) {
					_num += this.inputStr[_i];
					_i++;
				}
				this.showToken(_num, "ERROR");
			} else if (this.inputStr[_i] === ":") {
				this.showToken(_num, "linenumber");
			} else {
				this.showToken(_num, "const");
			}
			return _i;
		};

		o.otherProcess = function (_i) {
			var _other = "";
			if (this.inputStr[_i] === "(") {
				_other += this.inputStr[_i];
				_i++;
			}
			while (!this.isAlNum(this.inputStr[_i]) &&
				   (this.inputStr[_i] != " ") &&
				   (this.inputStr[_i] != "(") &&
				   (this.inputStr[_i] != ")")) {
				_other += this.inputStr[_i];
				_i++;
			}
			if (this.inputStr[_i] === ")") {
				_other += this.inputStr[_i];
				_i++;
			}

			if (this.isLegal(_other, this.operator) || this.isLegal(_other, this.comparision)) {
				this.showToken(_other, "operator");
			} else if (this.isLegal(_other, this.interpunction)) {
				this.showToken(_other, "delimiter");
			} else {
				this.showToken(_other, "ERROR");
			}
			return _i;
		};

		o.isLegal = function (_char, _type) {
			return !!(_type.includes(_char));
		};

		o.isNum = function (_char) {
			if (_char.length != 1) {
				return false;
			} else {
				var _reg = /\d/;
				return _reg.test(_char);
			}
		};

		o.isAlpha = function (_char) {
			if (_char.length != 1) {
				return false;
			} else {
				var _reg = /[a-zA-Z]/;
				return _reg.test(_char);
			}
		};

		o.isAlNum = function (_char) {
			return !!(this.isNum(_char) || this.isAlpha(_char))
		}

		o.main();
		return o;
	}
};

var ViewController = {
	create: function () {
		var o = {};

		o.initialize = function () {
			this.setNodeReferences();
			this.setEventListeners();
		};

// <div class="wrapper">
// 	<div class="input-area">
// 		<textarea id="input-form" ></textarea>
// 		<div class="input-buttons">
// 			<button id="input-submit">Submit</button>
// 			<button id="input-cancel">Cancel</button>
// 		</div>
// 	</div>
// 	<div class="control-line"></div>
// 	<div class="output-area">
// 		<div id="process-content"></div>
// 		<div id="output-content"></div>		
// 	</div>
// </div>

		o.setNodeReferences = function () {
			this.wrapper = document.querySelector(".wrapper");
			this.inputArea = document.querySelector(".input-area");
			this.controlLine = document.querySelector(".control-line");
			this.outputArea = document.querySelector(".output-area");
		};

		o.setEventListeners = function () {
			this.controlLine.addEventListener("mousedown", this.onLineMouseDown, false);
		}

		o.onLineMouseDown = function (event) {
			console.log(this);
			o._left = o.wrapper.getBoundingClientRect().left;
			o._width = o.wrapper.getBoundingClientRect().width;
			document.addEventListener("mousemove", o.onMouseMove, false);
			document.addEventListener("mouseup", o.onMouseUp, false);
		};

		o.onMouseMove = function (event) {
			var _percent = (event.clientX - o._left) / o._width;
			// o.inputArea.style.width = (event.clientX - o._left) + "px";
			o.inputArea.style.width = ((_percent * o._width) - 5) + "px";
			o.outputArea.style.width = (((1 - _percent) * o._width) - 5) + "px";
		};

		o.onMouseUp = function (event) {
			console.log(this + "moveup");
			document.removeEventListener("mousemove", o.onMouseMove, false);
			document.removeEventListener("mouseup", o.onMouseUp, false);
		};

		o.initialize();
		return o;
	}
};

var LA = LexicalAnalyser.create();
var VC = ViewController.create();
</script>
</html>