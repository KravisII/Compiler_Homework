<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta charset="UTF-8">
	<title>编译原理 实验1 词法分析</title>
</head>
<style>
</style>
<body>
	<div id="input">
		<textarea id="input-form" rows="10" cols="50"></textarea>
		<button id="input-submit">Submit</button>
	</div>

	<div id="process">
		<h1>Process</h1>
		<div id="process-content"></div>
	</div>
	<div id="output">
		<h1>Output</h1>
		<div id="output-content"></div>
	</div>
</body>
<script>
var LexicalAnalyser = {
	create: function () {
		var o = {};

		// Others
		o.name = "LexicalAnalyser";

		// Nodes
		o.outputContent;

		// Key Words
		o.keyword;
		o.operator;
		o.comparision;
		o.interpunction;

		// Strings
		o.inputStr;

		// Functions
		o.main = function () {
			this.setNodeReferences();
			this.testInput();
			this.setEventListeners();
			this.setDataValue();
		};

		o.testInput = function () {
			this.inputForm.value = "\/*example*\/\n    b=1\\\n00\n101:a=2*(1+3)\n    IF(b>10) THEN\n        a=1\n    ELSE IF(b>=5) THEN\n        a=2\n    ELSE\n        GOTO 101";
		};

		o.setNodeReferences = function () {
			this.inputForm = document.querySelector("#input-form");
			this.inputSubmit = document.querySelector("#input-submit");
			this.processContent = document.querySelector("#process-content");
			this.outputContent = document.querySelector("#output-content");
		};

		o.setEventListeners = function () {
			this.inputSubmit.addEventListener("click", this.clickSubmit.bind(this));
		};

		o.clickSubmit = function () {
			this.start();
		};

		o.setDataValue = function () {
			this.keyword = ["IF", "THEN", "ELSE", "GOTO"];
			this.operator = ["+", "-", "*", "/"];
			this.comparision = [">", ">=", "<", "<=", "=", "<>"];
			this.interpunction = [",", ":", "(", ")"];
		};

		o.showMessage = function (_text, _title) {
			this.processContent.innerText += _title + ":\n";
			this.processContent.innerText += _text + "\n\n";
		};

		o.start = function () {
			// Get Source Code
			this.inputStr = this.inputForm.value;
			this.showMessage(this.inputStr, "Source Code");
			// Begin Pre Process
			this.inputStr = this.preProcess(this.inputStr);
			this.showMessage(this.inputStr ,"Pre Process");
			// Begin Process
			this.process(this.inputStr);
		};

		o.preProcess = function (_str) {
			var _tempStr = this._removeComment(_str);
			_tempStr = this._removeLineBreak(_tempStr);
			_tempStr = this._removeMultiSpace(_tempStr);
			_tempStr = this._addEOF(_tempStr);
			return _tempStr;
		};

		o._removeComment = function (_str) {
			var _regStr = "(/\\\*([^*]|[\\\r\\\n]|(\\\*+([^*/]|[\\\r\\\n])))*\\\*+/)|(//.*)"; 
			var _reg = new RegExp(_regStr,"g"); 
			return _str.replace(_reg, "");
		};

		o._removeLineBreak = function (_str) {
			var _reg = /\\\n/g;
			return _str.replace(_reg, "");
		};

		o._removeMultiSpace = function (_str) {
			var _reg = /\s+/g;
			return _str.replace(_reg, " ");
		};

		o._addEOF = function (_str) {
			return _str + "#";
		}

		o.process = function (_str) {
			var _length = _str.length;
			for (var i = 0; i < _length; 0) {
				if (_str[i] === ' ') {
					i++;
					continue;
				} else if (_str[i] === '#') {
					break;
				} else if (this.isAlpha(_str[i])) {
					i = this.letterProcess(i)
				} else if (this.isNum(_str[i])) {
					i = this.numberProcess(i);
				} else {
					i = this.otherProcess(i)
				}
			}
		};

		o.showToken = function (_value, _type) {
			this.outputContent.innerText += '["' + _type + '", "' + _value + '"],\n';
		};

		o.letterProcess = function (_i) {
			var _letter = "";
			var _lineNum = "";
			while (this.isAlNum(this.inputStr[_i])) {
				_letter += this.inputStr[_i];
				_i++;
			}
			if (this.isLegal(_letter, this.keyword)) {
				this.showToken(_letter, "keyword");
				if (_letter === "GOTO") {
					_i++;
					while (this.isNum(this.inputStr[_i])) {
						_lineNum += this.inputStr[_i];
						_i++;
					}
					this.showToken(_lineNum, "linenumber");
				}
			} else {
				this.showToken(_letter, "identifier");
			}
			return _i;
		};

		o.numberProcess = function (_i) {
			var _num = "";
			while (this.isNum(this.inputStr[_i])) {
				_num += this.inputStr[_i];
				_i++;
			}
			if (this.isAlpha(this.inputStr[_i])) {
				while (this.isAlNum(this.inputStr[_i])) {
					_num += this.inputStr[_i];
					_i++;
				}
				this.showToken(_num, "ERROR");
			} else if (this.inputStr[_i] === ":") {
				this.showToken(_num, "linenumber");
			} else {
				this.showToken(_num, "const");
			}
			return _i;
		};

		o.otherProcess = function (_i) {
			var _other = "";
			if (this.inputStr[_i] === "(") {
				_other += this.inputStr[_i];
				_i++;
			}
			while (!this.isAlNum(this.inputStr[_i]) &&
				   (this.inputStr[_i] != " ") &&
				   (this.inputStr[_i] != "(") &&
				   (this.inputStr[_i] != ")")) {
				_other += this.inputStr[_i];
				_i++;
			}
			if (this.inputStr[_i] === ")") {
				_other += this.inputStr[_i];
				_i++;
			}

			if (this.isLegal(_other, this.operator) || this.isLegal(_other, this.comparision)) {
				this.showToken(_other, "operator");
			} else if (this.isLegal(_other, this.interpunction)) {
				this.showToken(_other, "delimiter");
			} else {
				this.showToken(_other, "ERROR");
			}
			return _i;
		};

		o.isLegal = function (_char, _type) {
			return !!(_type.includes(_char));
		};

		o.isNum = function (_char) {
			if (_char.length != 1) {
				return false;
			} else {
				var _reg = /\d/;
				return _reg.test(_char);
			}
		};

		o.isAlpha = function (_char) {
			if (_char.length != 1) {
				return false;
			} else {
				var _reg = /[a-zA-Z]/;
				return _reg.test(_char);
			}
		};

		o.isAlNum = function (_char) {
			return !!(this.isNum(_char) || this.isAlpha(_char))
		}

		o.main();
		return o;
	}
};

var LA = LexicalAnalyser.create();
</script>
</html>